<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Exercice de Projections Orthogonales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 20px; }
        .hidden { display: none; }
        
        /* Identification */
        #login-screen { background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: auto; }
        
        /* Layout de l'exercice */
        #exercise-container { display: flex; flex-direction: column; gap: 20px; }
        .main-content { display: flex; gap: 20px; align-items: center; }
        
        /* Vue 3D */
        .view-3d { flex: 2; background: white; padding: 10px; border: 2px solid #333; text-align: center; }
        .view-3d img { max-width: 100%; height: auto; }

        /* Grille de dépôt (La Croix) */
        .drop-grid { flex: 1; display: grid; grid-template-columns: repeat(3, 120px); grid-template-rows: repeat(3, 120px); gap: 10px; justify-content: center; }
        .drop-zone { border: 2px dashed #999; background: #fff; display: flex; align-items: center; justify-content: center; position: relative; }
        .drop-zone.hover { background: #e0e0e0; }
        .label { position: absolute; top: 2px; font-size: 10px; color: #666; }

        /* Zone des vignettes */
        #assets-palette { background: #ddd; padding: 15px; display: flex; gap: 10px; justify-content: center; min-height: 110px; border-radius: 8px; }
        .draggable-img { width: 100px; height: 100px; cursor: grab; border: 1px solid #000; background: white; }

        /* Boutons */
        .controls { text-align: center; margin-top: 20px; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Identification Élève</h2>
        <input type="text" id="nom" placeholder="Nom" required><br><br>
        <input type="text" id="prenom" placeholder="Prénom" required><br><br>
        <input type="text" id="classe" placeholder="Classe" required><br><br>
        <button onclick="startExercise()">Commencer l'exercice</button>
    </div>

    <div id="exercise-screen" class="hidden">
        <h3 id="ex-title">Exercice 1 / 10</h3>
        
        <div class="main-content">
            <div class="view-3d">
                <p>Vue 3D</p>
                <img id="img-3d" src="" alt="Vue 3D">
            </div>

            <div class="drop-grid">
                <div></div> <div class="drop-zone" data-expected="dessus"><span class="label">DESSUS</span></div>
                <div></div> <div class="drop-zone" data-expected="droite"><span class="label">DROITE</span></div>
                <div class="drop-zone" data-expected="face"><span class="label">FACE</span></div>
                <div class="drop-zone" data-expected="gauche"><span class="label">GAUCHE</span></div>
                
                <div></div> <div class="drop-zone" data-expected="dessous"><span class="label">DESSOUS</span></div>
                <div></div> </div>
        </div>

        <h4>Vues à placer (Glisser-Déposer) :</h4>
        <div id="assets-palette">
            </div>

        <div class="controls">
            <button id="next-btn" onclick="nextStep()">Valider et Suivant</button>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>Résultats</h2>
        <p id="final-score"></p>
        <div id="correction-log"></div>
        <button onclick="downloadPDF()">Télécharger mon PDF</button>
    </div>

    <script>
        let currentEx = 1;
        let score = 0;
        let userResults = [];
        const totalEx = 10;
        const viewTypes = ['face', 'gauche', 'droite', 'dessus', 'dessous'];

        function startExercise() {
            if(!document.getElementById('nom').value) return alert("Entrez votre nom");
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('exercise-screen').classList.remove('hidden');
            loadExercise();
        }

        function loadExercise() {
            document.getElementById('ex-title').innerText = `Exercice ${currentEx} / ${totalEx}`;
            document.getElementById('img-3d').src = `assets/3d${currentEx}.png`;
            
            // Réinitialiser les zones de dépôt
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.innerHTML = `<span class="label">${zone.getAttribute('data-expected').toUpperCase()}</span>`;
            });

            // Mélanger et charger les vignettes
            const palette = document.getElementById('assets-palette');
            palette.innerHTML = '';
            
            let shuffled = [...viewTypes].sort(() => Math.random() - 0.5);
            shuffled.forEach(type => {
                let img = document.createElement('img');
                img.src = `assets/${type}${currentEx}.png`;
                img.className = 'draggable-img';
                img.id = type; 
                img.draggable = true;
                img.ondragstart = (e) => e.dataTransfer.setData("text", e.target.id);
                palette.appendChild(img);
            });
            setupDropZones();
        }

        function setupDropZones() {
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.ondragover = (e) => e.preventDefault();
                zone.ondrop = (e) => {
                    e.preventDefault();
                    let data = e.dataTransfer.getData("text");
                    let draggedImg = document.getElementById(data);
                    if (zone.children.length > 1) return; // Une seule image par zone
                    zone.appendChild(draggedImg);
                };
            });
        }

        function nextStep() {
            // Correction de l'exercice actuel
            let errors = [];
            document.querySelectorAll('.drop-zone').forEach(zone => {
                let expected = zone.getAttribute('data-expected');
                let imgInside = zone.querySelector('img');
                if (!imgInside || imgInside.id !== expected) {
                    errors.push(expected);
                }
            });

            if (errors.length === 0) score += 2; // 2 points par exercice sans faute

            userResults.push({ex: currentEx, errors: errors});

            if (currentEx < totalEx) {
                currentEx++;
                loadExercise();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('exercise-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `Note finale : ${score} / 20`;
            
            let log = document.getElementById('correction-log');
            userResults.forEach(res => {
                let p = document.createElement('p');
                p.innerText = `Ex ${res.ex} : ${res.errors.length === 0 ? "Parfait" : "Erreurs sur : " + res.errors.join(', ')}`;
                log.appendChild(p);
            });
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let nom = document.getElementById('nom').value;
            let prenom = document.getElementById('prenom').value;
            
            doc.text(`Rapport d'exercice - ${nom} ${prenom}`, 10, 10);
            doc.text(`Note finale : ${score}/20`, 10, 20);
            
            let y = 30;
            userResults.forEach(res => {
                doc.text(`Exercice ${res.ex}: ${res.errors.length === 0 ? "OK" : "Erreurs: " + res.errors.join(', ')}`, 10, y);
                y += 10;
            });

            doc.save(`resultat_${nom}.pdf`);
        }
    </script>
</body>
</html>
